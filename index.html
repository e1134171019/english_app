<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <!-- Primary Meta Tags -->
  <title>英文練習 App</title>
  <meta name="title" content="英文練習 App">
  <meta name="description" content="專為英語學習設計的 Web 應用程式，支持單字記憶、聽力練習與動詞三態訓練。">
  
  <!-- Mobile Optimization -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#6366F1">
  
  <!-- iOS Specific -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="英文練習">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192.png">
  
  <!-- Prevent auto-zoom on input focus (iOS) -->
  <meta name="format-detection" content="telephone=no">
  
  <link rel="stylesheet" href="styles/app.css?v=20251227_mobile_opt">
  <link rel="stylesheet" href="styles/toast.css?v=20251226">
  <link rel="stylesheet" href="styles/add-word.css?v=20251227_AI">
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((reg) => console.log('Service Worker registered', reg))
          .catch((err) => console.log('Service Worker registration failed', err));
      });
    }
  </script>
</head>

<body>

  <!-- App Shell: Central Window -->
  <div id="app-shell">

    <!-- 1. Top App Bar -->
    <header class="top-app-bar">
      <!-- Left Action -->
      <button id="nav-back-btn" class="icon-btn hidden" aria-label="返回">
        <svg viewBox="0 0 24 24">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path>
        </svg>
      </button>
      <div id="nav-spacer-left" class="icon-btn" style="visibility: hidden;"></div>

      <!-- Title -->
      <div class="app-title" id="app-title">英文練習</div>

      <!-- Right Action -->
      <button id="nav-more-btn" class="icon-btn" aria-label="更多">
        <svg viewBox="0 0 24 24">
          <path
            d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z">
          </path>
        </svg>
      </button>
    </header>

    <!-- 2. Main Content (Scrollable Screens) -->
    <main id="main-content">

      <!-- A. Home Screen -->
      <section id="home-screen" class="screen active">
        <div class="card home-header-card">
          <div style="font-size: var(--text-sm); color: var(--text-sub);">今日目標達成率</div>
          <div
            style="position: relative; height: 8px; background: var(--border-color); border-radius: 4px; margin: 12px 0; overflow: hidden;">
            <div style="width: 45%; height: 100%; background: var(--primary);"></div>
          </div>
          <div class="stats-summary">
            <div class="stat-item">
              <div class="value">0</div>
              <div class="label">已練習</div>
            </div>
            <div class="stat-item">
              <div class="value">0</div>
              <div class="label">待複習</div>
            </div>
          </div>
        </div>

        <!-- Bento Grid Menu -->
        <h3 style="font-size: var(--text-sm); color: var(--text-hint); margin: 0 0 8px 4px;">開始練習</h3>
        <div class="bento-grid">
          <!-- Hero Item -->
          <div class="bento-item hero nav-to-screen" data-screen="level-select-screen" data-mode="practice">
            <svg class="icon" viewBox="0 0 24 24">
              <path
                d="M12 6.09L14.77 12H9.23L12 6.09M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2.19-2h4.38L12 11.35 9.81 18zm3.38-10.9h-2.38l-2.03 4.4h6.44l-2.03-4.4z">
              </path>
            </svg>
            <div style="text-align: left;">
              <div class="label">單字練習</div>
              <div style="font-size: 10px; color: var(--text-sub);">單字卡模式</div>
            </div>
          </div>

          <div class="bento-item nav-to-screen" data-screen="level-select-screen" data-mode="quiz">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"></path>
            </svg>
            <div class="label">聽力練習</div>
          </div>

          <div class="bento-item nav-to-screen" data-screen="verb3-screen">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path>
            </svg>
            <div class="label">動詞三態</div>
          </div>

          <div class="bento-item nav-to-screen" data-screen="custom-training-screen">
            <svg class="icon" viewBox="0 0 24 24">
              <path
                d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z">
              </path>
            </svg>
            <div class="label">我的專屬</div>
          </div>

          <div class="bento-item nav-to-screen" data-screen="add-screen">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
            </svg>
            <div class="label">新增</div>
          </div>

          <div class="bento-item nav-to-screen" data-screen="delete-screen">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path>
            </svg>
            <div class="label">管理刪除</div>
          </div>
        </div>
      </section>

      <!-- B. Level Select Screen -->
      <section id="level-select-screen" class="screen">
        <h2 style="font-size: var(--text-lg); margin-bottom: 16px;">Step 1: 選擇學制</h2>
        <div class="card" style="margin-bottom: 24px;">
          <div class="input-group">
            <label class="nav-label" style="font-size: 12px; margin-bottom: 8px; display: block;">教育階段</label>
            <div class="chip-group" id="tier1-chips">
              <button type="button" class="chip" data-action="select-tier1" data-val="JH">國中 Junior High</button>
              <button type="button" class="chip" data-action="select-tier1" data-val="SH">高中 Senior High</button>
              <button type="button" class="chip" data-action="select-tier1" data-val="ADV">進階 Advanced</button>
            </div>
          </div>
        </div>

        <h2 style="font-size: var(--text-lg); margin-bottom: 16px;">Step 2: 選擇等級</h2>
        <div class="card" id="tier2-container">
          <div class="chip-group" id="tier2-chips">
            <!-- Dynamic Injection -->
            <div style="padding: 20px; color: var(--text-hint); text-align: center; width: 100%;">請先選擇學制</div>
          </div>
        </div>

        <button type="button" class="btn btn-primary" data-action="confirm-level" style="margin-top: 32px;">開始</button>
      </section>

      <!-- C. Practice Screen -->
      <section id="practice-screen" class="screen">
        <!-- Progress Header -->
        <div
          style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: var(--text-sm); color: var(--text-sub);">
          <span id="practice-mode-label">單字練習</span>
          <span id="practice-counter">1 / 20</span>
        </div>
        <div style="height: 4px; background: var(--border-color); border-radius: 2px; margin-bottom: 24px;">
          <div id="practice-progress"
            style="width: 5%; height: 100%; background: var(--primary); border-radius: 2px; transition: width 0.3s;">
          </div>
        </div>

        <!-- Flashcard Area -->
        <div class="flashcard-wrapper">
          <div class="flashcard-container">
            <div id="flashcard-stage" class="flashcard-stage">
              <div id="flashcard" class="flashcard">
                <!-- Front -->
                <div class="card-face front">
                  <div class="chip" style="position: absolute; top: 16px; left: 16px; pointer-events: none;">Level <span
                      id="card-level-badge"></span></div>
                  <div id="card-school-label"
                    style="position: absolute; top: 16px; right: 16px; font-size: 12px; color: var(--text-sub);"></div>
                  <h2 id="card-front-text" class="card-front-text">中文</h2>
                  <div style="color: var(--text-hint); font-size: var(--text-sm); margin-top: 16px;">點擊翻面</div>
                </div>

                <!-- Back -->
                <div class="card-face back">
                  <div
                    style="width: 100%; display: flex; justify-content: space-between; align-items: start; margin-bottom: 2px;">
                    <div style="display: flex; flex-direction: column; align-items: flex-start;">
                      <span class="chip"
                        style="background: var(--bg-body); border: 1px solid var(--border-color); color: var(--text-sub);"
                        id="card-pos">n.</span>
                    </div>

                    <button type="button" class="icon-btn" data-action="speak-word" title="發音" aria-label="Speak word">
                      <svg viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                        <path
                          d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z">
                        </path>
                      </svg>
                    </button>
                  </div>
                  <h2 id="card-back-text" class="card-back-text">English
                  </h2>
                  <div id="card-phonetic"
                    style="color: var(--text-sub); margin-bottom: 24px; font-family: monospace; font-size: 1.1rem;">
                    /phonetic/</div>

                  <!-- Example Sentence Area -->
                  <div style="width: 100%; margin-bottom: 24px;">
                    <!-- English Block -->
                    <div
                      style="background: var(--bg-body); padding: 16px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border-color); display: flex; align-items: flex-start; justify-content: space-between;">
                      <div id="card-sentence-en"
                        style="line-height: 1.5; font-size: 1.1rem; color: var(--text-main); flex: 1; margin-right: 8px;">
                      </div>
                      <button type="button" class="icon-btn" data-action="speak-example" title="播放例句"
                        aria-label="Speak example"
                        style="width: 24px; height: 24px; color: var(--primary-color); flex-shrink: 0; padding: 0;">
                        <svg viewBox="0 0 24 24">
                          <path
                            d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z">
                          </path>
                        </svg>
                      </button>
                    </div>

                    <!-- Chinese Block -->
                    <div
                      style="background: var(--bg-body); padding: 12px 16px; border-radius: 12px; border: 1px solid var(--border-color); font-size: var(--text-sm); color: var(--text-main);">
                      <div id="card-sentence-zh"></div>
                    </div>
                  </div>

                  <!-- Related Info (Word Family / Verb Forms) -->
                  <div id="card-related-info"
                    style="font-size: 0.9rem; line-height: 1.5; color: var(--text-sub); width: 100%; text-align: left; padding-top: 12px; border-top: 1px dashed var(--border-color); margin-top: auto;">
                    <!-- Dynamic content -->
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- Controls -->
        <div
          style="display: flex; align-items: center; justify-content: center; gap: 40px; width: 100%; max-width: 320px; margin: 24px auto 48px auto;">
          <button type="button" class="icon-btn icon-btn-primary" data-action="prev-card"
            style="width: 52px; height: 52px; border: none;">
            <svg viewBox="0 0 24 24">
              <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
            </svg>
          </button>

          <button type="button" class="btn btn-text" id="autoplay-btn" data-action="toggle-autoplay">
            <svg style="width: 20px; height: 20px; margin-right: 6px;" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"></path>
            </svg>
            自動播放
          </button>

          <button type="button" class="icon-btn icon-btn-primary" data-action="next-card"
            style="width: 52px; height: 52px; border: none;">
            <svg viewBox="0 0 24 24">
              <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path>
            </svg>
          </button>
        </div>
      </section>

      <!-- D. Quiz Screen -->
      <section id="quiz-screen" class="screen">
        <div
          style="text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center; flex: 1; justify-content: center;">
          <div class="card" data-action="speak-quiz"
            style="display: inline-flex; padding: 20px; border-radius: 50%; margin-bottom: 16px; cursor: pointer; transition: transform 0.1s;">
            <svg style="width: 48px; height: 48px; fill: var(--primary);" viewBox="0 0 24 24">
              <path
                d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z">
              </path>
            </svg>
          </div>
          <div style="color: var(--text-hint); margin-bottom: 20px; font-size: 0.9rem;">點擊播放圖示重聽</div>

          <input type="text" id="quiz-input" class="input-field" placeholder="輸入聽到的單字" autocomplete="off"
            style="text-align: center; font-size: 1.5rem; max-width: 280px; margin-bottom: 16px;">

          <div id="quiz-feedback" class="hidden"
            style="margin-top: 8px; margin-bottom: 16px; padding: 8px; border-radius: 8px;"></div>

          <div style="display: flex; gap: 12px; width: 100%; max-width: 280px;">
            <button type="button" id="quiz-skip-btn" class="btn btn-outline skip-quiz-btn" data-action="skip-quiz"
              style="flex: 1;">跳過</button>
            <button type="button" id="quiz-submit-btn" class="btn btn-primary submit-quiz-btn" data-action="submit-quiz"
              style="flex: 1;">送出</button>
            <button type="button" id="quiz-next-btn" class="btn btn-primary hidden" data-action="next-quiz"
              style="flex: 1; background: var(--success); border-color: var(--success);">下一題</button>
          </div>

          <!-- Navigation Row (Prev / Count / Next) -->
          <div
            style="display: flex; align-items: center; justify-content: space-between; width: 100%; max-width: 350px; margin-top: 24px;">
            <button type="button" class="btn btn-outline" data-action="prev-quiz" style="min-width: 80px;">上一題</button>
            <span id="quiz-counter"
              style="font-weight: 500; color: var(--text-sub); white-space: nowrap; margin: 0 12px;">1 / 10</span>
            <button type="button" class="btn btn-outline" data-action="next-quiz" style="min-width: 80px;">下一題</button>
          </div>
        </div>
      </section>

      <!-- E. Verb3 Screen -->
      <section id="verb3-screen" class="screen">
        <div class="chip-group" style="justify-content: center; margin-bottom: 24px;">
          <button type="button" class="chip active" id="v3-tab-jh" data-action="switch-verb3-level" data-level="JH">國中
            (JH)</button>
          <button type="button" class="chip" id="v3-tab-sh" data-action="switch-verb3-level" data-level="SH">高中
            (SH)</button>
        </div>

        <div class="card" style="text-align: center;">
          <div id="v3-header-info"
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 0.85rem; color: var(--text-hint);">
            <div id="v3-level-badge" class="badge">Level</div>
            <div id="v3-counter">1 / 10</div>
          </div>

          <div style="font-size: var(--text-sm); color: var(--text-hint);">Base Form (原型)</div>
          <h2 id="v3-base" style="font-size: 2.2rem; margin: 4px 0 8px; color: var(--primary);">go</h2>
          <div id="v3-zh" style="font-size: 1.25rem; font-weight: 500; margin-bottom: 24px;">去</div>

          <div style="text-align: left; margin-bottom: 16px;">
            <label style="font-size: var(--text-xs); margin-bottom: 4px; display: block; color: var(--text-sub);">Past
              Tense (過去式)</label>
            <input type="text" id="v3-past" class="input-field" autocomplete="off" placeholder="例如: went">
          </div>

          <div style="text-align: left; margin-bottom: 24px;">
            <label style="font-size: var(--text-xs); margin-bottom: 4px; display: block; color: var(--text-sub);">Past
              Participle (過去分詞)</label>
            <input type="text" id="v3-pp" class="input-field" autocomplete="off" placeholder="例如: gone">
          </div>

          <!-- Action Area -->
          <button type="button" id="v3-check-btn" class="btn btn-primary" data-action="check-verb3"
            style="width: 100%; margin-bottom: 16px;">檢查答案</button>

          <div id="v3-msg" class="hidden"
            style="margin-bottom: 24px; font-weight: 500; padding: 12px; border-radius: 8px;"></div>

          <!-- Stats for TS-16 -->
          <div id="v3-stats" class="hidden"
            style="display: flex; gap: 12px; justify-content: center; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 16px;">
            <span>正確: <span id="v3-stat-correct" style="color: var(--success);">0</span></span>
            <span>錯誤: <span id="v3-stat-wrong" style="color: var(--error);">0</span></span>
          </div>

          <!-- Navigation Area (Bottom) -->
          <div
            style="display: flex; gap: 16px; justify-content: center; border-top: 1px solid var(--border-color); padding-top: 16px;">
            <button type="button" id="v3-prev-btn" class="btn btn-outline" data-action="prev-verb3"
              style="flex: 1;">上一個</button>
            <button type="button" id="v3-next-btn" class="btn btn-outline" data-action="next-verb3" style="flex: 1;">
              下一個</button>
          </div>
        </div>
      </section>

      <!-- Custom Training Screen (我的專屬) -->
      <div id="custom-training-screen" class="screen">
        <!-- 輸入與建立區塊 -->
        <div class="card" style="flex-shrink: 0; padding-top: 8px;">

          <!-- 輸入區 -->
          <textarea id="deck-input" class="input-field" rows="5"
            placeholder="輸入單字（換行或空格分隔，最多 100 個）&#10;例如：apple banana orange"
            style="resize: vertical; min-height: 120px; margin-bottom: 16px;"></textarea>

          <!-- 模式選擇按鈕 -->
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-primary" data-action="create-and-start" data-mode="practice"
              style="flex: 1;">單字練習</button>
            <button class="btn btn-primary" data-action="create-and-start" data-mode="quiz"
              style="flex: 1;">聽力練習</button>
            <button class="btn btn-primary" data-action="create-and-start" data-mode="verb3"
              style="flex: 1;">動詞三態</button>
          </div>
        </div>

        <!-- 題庫列表 -->
        <div class="card" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
          <h3 style="margin: 0 0 16px 0; font-size: 1.125rem; font-weight: 600;">我的題庫</h3>
          <div id="custom-deck-list" style="flex: 1; overflow-y: auto;">
            <!-- 動態內容由 JS 生成 -->
            <p class="empty-state">尚無自訂題庫<br>請在上方輸入單字並選擇模式</p>
          </div>
        </div>
      </div>

      <!-- G. Add Word Screen - AI Generated Words Preview -->
      <section id="add-screen" class="screen">
        <div class="add-word-container">

          <!-- Section 1: Input Area -->
          <div class="input-card">
            <h3 class="section-title">手動生成單字</h3>
            <div class="input-section">
              <input type="text" id="word-input" placeholder="輸入單字（可用逗號分隔多個）..." class="word-input">
              <button id="generate-btn" class="primary-btn">🔍 生成</button>
            </div>
          </div>

          <!-- Section 2: Generated Words List -->
          <div class="words-card">
            <div class="section-header">
              <h3 class="section-title">今日 AI 生成 (<span id="word-count">0</span>)</h3>
              <button id="clear-all-btn" class="text-btn">🗑️ 全部刪除</button>
            </div>

            <div id="ai-words-list" class="words-list">
              <p class="empty-state">今日尚無 AI 生成單字</p>
            </div>
          </div>

        </div>
      </section>
      <section id="delete-screen" class="screen">
        <div class="card">
          <h3 style="margin:0;">管理單字 (TBD)</h3>
        </div>
      </section>

    </main>

    <!-- Global Floating Back Button (TS-23) -->
    <button type="button" id="floating-back-btn" class="floating-back-btn hidden" data-action="go-back">
      <svg viewBox="0 0 24 24">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path>
      </svg>
      <span>返回</span>
    </button>

    <!-- 3. Bottom Navigation -->
    <nav class="bottom-nav">
      <button class="nav-item active nav-to-screen" data-screen="home-screen">
        <svg viewBox="0 0 24 24">
          <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path>
        </svg>
        <span class="nav-label">首頁</span>
      </button>
      <button class="nav-item nav-to-screen" data-screen="level-select-screen" data-mode="practice">
        <svg viewBox="0 0 24 24">
          <path
            d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z">
          </path>
        </svg>
        <span class="nav-label">單字</span>
      </button>
      <button class="nav-item nav-to-screen" data-screen="level-select-screen" data-mode="quiz">
        <svg viewBox="0 0 24 24">
          <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"></path>
        </svg>
        <span class="nav-label">聽力練習</span>
      </button>
      <button class="nav-item nav-to-screen" data-screen="verb3-screen">
        <svg viewBox="0 0 24 24">
          <path
            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z">
          </path>
        </svg>
        <span class="nav-label">三態</span>
      </button>
      <!-- 5th Item Custom -->
      <button class="nav-item nav-to-screen" data-screen="custom-training-screen">
        <svg viewBox="0 0 24 24">
          <path
            d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z">
          </path>
        </svg>
        <span class="nav-label">我的專屬</span>
      </button>
    </nav>

    <!-- Tooltip Layer -->
    <div id="translation-tooltip"></div>

    <!-- Floating Back Button -->
    <button id="floating-back-btn" class="floating-back-btn hidden" data-action="back" title="返回">
      ←
    </button>

  </div>

  <script type="module" src="main.js?v=20251227_AI_VERCEL"></script>
</body>

</html>